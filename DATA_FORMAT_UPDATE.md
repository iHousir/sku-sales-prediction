# 数据格式更新说明

## 修改概述

根据实际业务需求，系统已更新以支持更灵活的数据格式。

## 主要变更

### 1. 字段配置调整

#### 必需字段（Required）
以下字段是系统正常运行所必需的：

| 字段名 | 说明 | 备注 |
|--------|------|------|
| 下单时间 | 订单日期 | 必须 |
| 数量 | 销量 | **允许负数**（表示退货等情况） |
| 送货专卖店卡号 | 店铺ID | 必须 |
| 货品代码 | SKU代码 | **作为产品唯一标识** |
| 省 | 省份 | 必须 |
| 市 | 城市 | 必须 |

#### 可选字段（Optional）
以下字段如果数据中不存在，系统会自动跳过：

| 字段名 | 说明 |
|--------|------|
| 货品名称 | 产品名称（可选） |
| 送货地址 | 详细地址（可选） |
| 配送方式 | 配送方式（可选） |
| 月份 | 月份标识（可选） |

### 2. 核心改动

#### (1) 使用货品代码作为产品唯一标识
- **之前**：使用"货品名称"字段作为产品标识
- **现在**：使用"货品代码"字段作为产品唯一标识
- **原因**：更符合实际业务场景，代码比名称更稳定

#### (2) 支持负数销量
- **之前**：自动过滤负数销量
- **现在**：保留负数销量
- **原因**：负数通常表示退货、换货等业务场景
- **影响**：系统会在摘要统计中报告负数销量记录数

#### (3) 可选字段支持
- **之前**：所有字段都必须存在
- **现在**：只要求必需字段存在，可选字段可以缺失
- **原因**：提高系统灵活性，适应不同的数据源

## CSV数据格式示例

### 最小数据格式（只包含必需字段）

```csv
下单时间,数量,送货专卖店卡号,货品代码,省,市
2023-01-01,100,STORE001,SKU001,广东省,深圳市
2023-01-02,120,STORE001,SKU001,广东省,深圳市
2023-01-03,-15,STORE001,SKU001,广东省,深圳市
```

注意：第3行是负数销量（可能表示退货）

### 完整数据格式（包含可选字段）

```csv
下单时间,数量,送货专卖店卡号,货品代码,省,市,配送方式,月份
2023-01-01,100,STORE001,SKU001,广东省,深圳市,快递,2023-01
2023-01-02,120,STORE001,SKU001,广东省,深圳市,自提,2023-01
2023-01-03,-15,STORE001,SKU001,广东省,深圳市,快递,2023-01
```

## 代码示例

### 数据加载

```python
from src.forecaster import SalesForecaster
import pandas as pd

# 方式1：从CSV加载（只需要必需字段）
forecaster = SalesForecaster(data_path="sales_data.csv")

# 方式2：从DataFrame加载
df = pd.DataFrame({
    '下单时间': ['2023-01-01', '2023-01-02', '2023-01-03'],
    '数量': [100, 120, -15],  # 支持负数
    '送货专卖店卡号': ['STORE001', 'STORE001', 'STORE001'],
    '货品代码': ['SKU001', 'SKU001', 'SKU001'],  # 使用货品代码
    '省': ['广东省', '广东省', '广东省'],
    '市': ['深圳市', '深圳市', '深圳市']
})
forecaster = SalesForecaster(df=df)
```

### 数据验证

```python
from src.data_preprocessing import DataPreprocessor

# 加载数据
preprocessor = DataPreprocessor(data_path="sales_data.csv")

# 验证字段（只验证必需字段）
if preprocessor.validate_columns():
    print("✓ 数据验证通过")

# 清洗数据（保留负数销量）
cleaned_data = preprocessor.clean_data()

# 查看统计信息（包含负数销量统计）
summary = preprocessor.get_summary_statistics()
print(summary)
```

### 预测示例

```python
# 按店铺和货品代码进行预测
results = forecaster.forecast_by_dimension(
    dimension='store_id',      # 按店铺
    time_granularity='daily',  # 每日
    forecast_horizon=30        # 预测30天
)

# 系统会自动按"货品代码"分组预测
# 结果key格式: "店铺ID_货品代码"
for key, result in results.items():
    if result['success']:
        print(f"{key}: {result['best_model']}")
```

## 数据摘要统计

清洗后的数据摘要会包含以下信息：

```
总记录数          10000
总销量            148500  (包含负数)
平均销量          14.85
销量中位数        15.0
销量标准差        25.3
最小销量          -50     (退货)
最大销量          200
唯一产品数        50      (基于货品代码)
唯一店铺数        20
时间跨度          2023-01-01 至 2023-12-31
负数销量记录数    500     (新增)
```

## 兼容性说明

### 向后兼容
- 如果你的数据包含"货品名称"和"送货地址"字段，系统仍然可以正常工作
- 只是这些字段不会被用于核心预测逻辑

### 迁移建议
如果你之前使用旧格式的数据：
1. **必需操作**：确保数据包含所有必需字段
2. **推荐操作**：使用"货品代码"作为产品主键
3. **可选操作**：删除不再使用的可选字段以减小文件大小

## 生成示例数据

使用更新后的示例数据生成器：

```bash
python examples/generate_sample_data.py
```

这将生成包含以下特点的示例数据：
- 只包含必需字段
- 约5%的负数销量记录（模拟退货）
- 使用货品代码作为产品标识

## 常见问题

### Q1: 为什么使用货品代码而不是货品名称？
**A**: 货品代码通常是更稳定的唯一标识符。货品名称可能存在：
- 重复（不同代码但名称相同）
- 变化（产品改名但代码不变）
- 多语言或别名问题

### Q2: 负数销量如何影响预测？
**A**:
- 系统会保留负数销量，作为历史数据的一部分
- 时间序列聚合时，负数会被正常计算（相当于减少销量）
- 预测结果仍然基于历史模式，包括退货模式
- 最终预测值不会是负数（模型会确保非负）

### Q3: 缺少可选字段会影响预测吗？
**A**: 不会。可选字段不参与核心预测逻辑，只用于：
- 数据追溯和记录
- 辅助分析

### Q4: 如何在预测结果中查看负数影响？
**A**: 查看数据摘要统计：
```python
summary = forecaster.get_summary_statistics()
print(f"负数记录: {summary['负数销量记录数']}")
print(f"净销量: {summary['总销量']}")
```

## 技术细节

### 配置文件变更
文件：`src/config.py`

```python
# 新增必需字段配置
REQUIRED_COLUMNS = {
    "date": "下单时间",
    "quantity": "数量",
    "store_id": "送货专卖店卡号",
    "product_code": "货品代码",
    "province": "省",
    "city": "市",
}

# 新增可选字段配置
OPTIONAL_COLUMNS = {
    "product_name": "货品名称",
    "delivery_address": "送货地址",
    "delivery_method": "配送方式",
    "month": "月份"
}

# 产品标识字段
PRODUCT_ID_FIELD = "product_code"
```

### 数据处理逻辑变更
文件：`src/data_preprocessing.py`

1. **validate_columns()**: 只验证必需字段，警告缺少的可选字段
2. **clean_data()**: 移除"过滤负数"逻辑，添加负数统计
3. **prepare_forecast_data()**: 使用PRODUCT_ID_FIELD配置
4. **get_summary_statistics()**: 添加"负数销量记录数"统计

## 更新日期

2024-10-23

---

如有问题，请查看README.md或提交Issue。
